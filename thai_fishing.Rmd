---
title: "GFW and Human Rights"
output: html_notebook
---
# Introduction
The project aims to address to research questions relating to human rights violations and fisheries:  

1. Can GFW be used to detect human rights violations in fisheries?
2. Do human rights violations, particularly forced labor, drive overfishing?

## Load libraries

```{r load_libraries}
library(lubridate)
library(tidyverse)
library(bigrquery)
library(plotly)
library(broom)
```

## Load GFW data
```{r}
## Get all Thailand GFW Data
requery <- "no"
if (requery == "yes"){
sql <-  paste("SELECT
    year,
    mmsi, 
    timestamp, 
    lon, 
    lat, 
    hours, 
    measure_new_score, 
    distance_from_shore, 
    implied_speed, 
    eez_name
  FROM
    all_fishing_effort.all_fishing_effort_all_years
  WHERE
    flag_country_name = 'Thailand'",
  sep="")

project <-  "ucsb-gfw"
vesselQueryAll <- query_exec(sql,project,max_pages = Inf)

sql_vessels <-  paste("SELECT
  mmsi,
  country,
  general_vessel_type,
  length
FROM
  Vessel_Characteristics.complete_fishing_fleet_characteristics_2015",
sep="")
    
project <-  "ucsb-gfw"
vessel_characteristics <- query_exec(sql_vessels,project,max_pages = Inf)

save(vesselQueryAll,file="data/vesselQueryAll.Rdata")
save(vessel_characteristics,file="data/vessel_characteristics.Rdata")
} else {
  load("data/vesselQueryAll.Rdata")
  load("data/vessel_characteristics.Rdata")
}
```

```{r GFWdata}
thai_effort_processed <- vesselQueryAll %>%
  rename(Year = year) %>%
  mutate(Date = date(timestamp)) %>%
  mutate(Fishing = ifelse(measure_new_score >= 0.5 & 
                            !((distance_from_shore < 1000 & implied_speed < 1)),1,0)) %>%
  group_by(Date,Year,mmsi,Fishing) %>%
  ungroup() %>%
  group_by(mmsi,Year) %>%
  summarize(total_hours_fished = sum(hours*Fishing),
            Annual_Active_Days = n_distinct(Date),
            number_days_fishing = n_distinct(Date[Fishing==1]),
            number_days_transit = n_distinct(Date[Fishing==0]),
            hours_per_day = total_hours_fished / number_days_fishing,
            number_fishing_pings = sum(Fishing),
            number_observation_pings = n(),
            ping_ratio = number_fishing_pings/number_observation_pings,
            day_ratio = number_days_fishing/Annual_Active_Days) %>%
  left_join(vessel_characteristics,by="mmsi") %>%
    arrange(-hours_per_day)

thai_effort_processed %>%
  plot_ly(x=~total_hours_fished,type="histogram",text=~mmsi) %>%
  layout(barmode = "overlay")

knownOffenders <- thai_effort_processed %>%
  filter(mmsi %in% c(567000445,567000421,567025800)) %>%
  filter(Year == 2015)

modelFit <- lm(total_hours_fished~number_days_fishing+0,thai_effort_processed,offset=rep(0, nrow(thai_effort_processed)))
slope <- tidy(modelFit)$estimate
thai_effort_processed %>%
  plot_ly(x= ~number_days_fishing, y =~total_hours_fished,
          mode="scatter") %>%
  add_markers(size=~Annual_Active_Days,
              color=~Annual_Active_Days,
              text = ~paste('Vessel: ', mmsi,
                            '<br>Year: ',Year,
                            '<br>Annual Hours Fished: ',round(total_hours_fished),
                            '<br>Annual Days Fished: ',round(number_days_fishing),
                            '<br>Annual Days Active: ',round(Annual_Active_Days)),
              name = "Individual Vessels") %>%
  add_trace(x = c(0, max(thai_effort_processed$number_days_fishing)), 
            y = c(0, slope*max(thai_effort_processed$number_days_fishing)),mode="lines",name="Linear Model Fit") %>%
  layout(xaxis = list(title = "Annual Days Fished"),yaxis = list(title = "Annual Hours Fished")) %>%
  add_annotations(x = knownOffenders$number_days_fishing,
                  y = knownOffenders$total_hours_fished,
                  text = "Known suspect of<br>human trafficking",
                  xref = "x",
                  yref = "y",
                  showarrow = TRUE,
                  arrowhead = 4,
                  arrowsize = .5,
                  ax = c(-20,0,-40),
                  ay = c(-40,-60,-40))
```

```{r}
library(tmap)
library(rgdal)
library(sp)
library(leaflet)
eez <- readOGR(dsn = "data/World_EEZ_v9_20161021_LR", layer = "eez_lr", stringsAsFactors = FALSE)
eez@data$GeoName <- gsub(" Exclusive Economic Zone"," EEZ",eez@data$GeoName)
world <- readOGR(dsn = "data/TM_WORLD_BORDERS-0.3", layer = "TM_WORLD_BORDERS-0.3", stringsAsFactors = FALSE)
```


```{r}
vesselNumber <- 567334000
yearPlot <- 2012

fishingPoints <- vesselQueryAll %>%
  filter(mmsi == vesselNumber) %>%
  filter(measure_new_score >= 0.5) %>%
  filter(year == yearPlot) %>%
  filter(!(distance_from_shore < 1000 & implied_speed < 1)) %>%
  select(lon,
         lat) %>%
  SpatialPoints()

transitPoints <- vesselQueryAll %>%
  filter(mmsi == vesselNumber) %>%
  filter(measure_new_score < 0.5 & !(distance_from_shore < 1000 & implied_speed < 1)) %>%
  filter(year == yearPlot) %>%
  select(lon,
         lat) %>%
  SpatialPoints()

portPoints <- vesselQueryAll %>%
  filter(mmsi == vesselNumber) %>%
  filter(year == yearPlot & (distance_from_shore < 1000 & implied_speed < 1)) %>%
  select(lon,
         lat) %>%
  SpatialPoints()

eezOverlap <- overlay<-raster::intersect(eez,
                                         rbind(fishingPoints,
                              transitPoints,
                              portPoints))

extentPoints <- rbind(fishingPoints,
                              transitPoints,
                              portPoints) %>%
  bbox()


# qtm(world,
#          bbox = extentPoints, title=paste("Vessel: ",vesselNumber,"\nYear: ",yearPlot),style="cobalt") +
#   tm_borders() +
#    tm_shape(fishingPoints) +
#   tm_dots(col="red") +
#   tm_shape(transitPoints) +
#   tm_dots(col="blue") +
#   tm_shape(portPoints) +
#   tm_dots(col="green") +
#   tm_shape(eezOverlap) +
#   tm_borders(col="orange") +
#   tm_text("GeoName",size=1) +
#   tm_add_legend(type="symbol",labels=c("Transit","Fishing","Port"),col=c("blue","red","green"),shape=16,size=0.25)

leaflet() %>%
  # fitBounds(0, 60, 35, 72) %>%
  addTiles(group = "OSM (default)") %>%
  addPolygons(data = eez,
    fillOpacity = 0.15, 
    fillColor = "blue", 
    stroke=TRUE,
    weight=1,
    color="black",
    popup = ~paste0("<font color=#000000>",
      "<b>EEZ: </b>", GeoName, "<br>",
    "</font>"))  %>%
  addCircleMarkers(data=transitPoints,
              color="blue",
              stroke=FALSE,
              fillOpacity = 0.5,
              radius = 3,
              group = "Transit (Blue)")  %>%
  addCircleMarkers(data=fishingPoints,
              color="red",
              stroke=FALSE,
              fillOpacity = 0.5,
              radius = 3,
              group = "Fishing (Red)")  %>%
  addCircleMarkers(data=portPoints,
              color="green",
              stroke=FALSE,
              fillOpacity = 0.5,
              radius = 3,
              group = "Port (Green)") %>%
  fitBounds(lng1=extentPoints[1],lat1=extentPoints[2],lng2=extentPoints[3],lat2=extentPoints[4]) %>%
  addLayersControl(
    overlayGroups = c("Fishing (Red)", "Transit (Blue)","Port (Green)"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

