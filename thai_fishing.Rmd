---
title: "GFW and Human Rights"
output: html_notebook
---
# Introduction
The project aims to address to research questions relating to human rights violations and fisheries:  

1. Can GFW be used to detect human rights violations in fisheries?
2. Do human rights violations, particularly forced labor, drive overfishing?

## Load libraries

```{r load_libraries}
library(lubridate)
library(tidyverse)
library(bigrquery)
library(plotly)
```

## Load GFW data

```{r GFWdata}
sql <-  paste("SELECT
    mmsi,
    flag_country_name,
    YEAR(timestamp) Year,
    SUM(hours) total_hours_fished,
    COUNT(DISTINCT DATE(timestamp)) number_days_fishing
  FROM
    all_fishing_effort.all_fishing_effort_all_years
  WHERE
    flag_country_name = 'Thailand'
  AND
    measure_new_score >=.5
  AND
    NOT (distance_from_shore < 1000 AND implied_speed < 1)
  GROUP BY
    flag_country_name,
    mmsi,
    Year",
  sep="")

project <-  "ucsb-gfw"
thai_effort <- query_exec(sql,project,max_pages = Inf)

thai_effort_processed <- thai_effort %>%
  arrange(-total_hours_fished) %>%
  mutate(hours_per_day = total_hours_fished / number_days_fishing)

vessel_list <- data.frame(mmsi = unique(thai_effort$mmsi))

sql_vessels <-  paste("SELECT
  mmsi,
  country,
  general_vessel_type,
  length
FROM
  Vessel_Characteristics.complete_fishing_fleet_characteristics_2015",
sep="")
    
project <-  "ucsb-gfw"
vessel_characteristics <- query_exec(sql_vessels,project,max_pages = Inf)

thai_effort_processed <- thai_effort_processed %>%
  left_join(vessel_characteristics,by="mmsi")

thai_effort_processed %>%
  ggplot(aes(x=total_hours_fished)) +
  geom_histogram()

thai_effort_processed %>%
  ggplot(aes(x=number_days_fishing)) +
  geom_histogram() +
  facet_wrap(~Year,scales="free_y")

thai_effort_processed %>%
  ggplot(aes(x=hours_per_day)) +
  geom_histogram() +
  facet_wrap(~Year,scales="free_y")
```

```{r}
sql <-  paste("SELECT
    mmsi,
    flag_country_name,
    YEAR(timestamp) Year,
    COUNT(DISTINCT(timestamp)) number_fishing_pings
  FROM
    all_fishing_effort.all_fishing_effort_all_years
  WHERE
    flag_country_name = 'Thailand'
  AND
    measure_new_score >=.5
  AND
    NOT (distance_from_shore < 1000 AND implied_speed < 1)
  GROUP BY
    flag_country_name,
    mmsi,
    Year",
  sep="")

project <-  "ucsb-gfw"
thai_fishing_pings <- query_exec(sql,project,max_pages = Inf)

sql <-  paste("SELECT
    mmsi,
    flag_country_name,
    YEAR(timestamp) Year,
    COUNT(DISTINCT(timestamp)) number_observation_pings
  FROM
    all_fishing_effort.all_fishing_effort_all_years
  WHERE
    flag_country_name = 'Thailand'
  GROUP BY
    flag_country_name,
    mmsi,
    Year",
  sep="")

project <-  "ucsb-gfw"
thai_observation_pings <- query_exec(sql,project,max_pages = Inf)

allPings <- thai_observation_pings %>%
  left_join(thai_fishing_pings)  %>%
  as_tibble() %>%
  mutate(number_fishing_pings=replace(number_fishing_pings, is.na(number_fishing_pings), 0)) %>%
  mutate(ping_ratio = number_fishing_pings/number_observation_pings) %>%
  arrange(-ping_ratio)

allPings %>%
  ggplot(aes(x=number_observation_pings,y=number_fishing_pings)) +
  geom_point()

allPings %>%
  ggplot(aes(x=ping_ratio)) +
  geom_histogram()
```

